<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Maps Business Scraper</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e4e4e4;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid #333;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 10px;
    }

    header p {
      color: #888;
      font-size: 1.1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #1f2937;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #333;
    }

    .card h2 {
      color: #4ecca3;
      margin-bottom: 20px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-full {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
      font-size: 0.9rem;
    }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #111827;
      color: #fff;
      font-size: 1rem;
      margin-bottom: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #4ecca3;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: #4ecca3;
      color: #1a1a2e;
      width: 100%;
    }

    .btn-primary:hover {
      background: #3db892;
    }

    .btn-danger {
      background: #ef4444;
      color: #fff;
      width: 100%;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .hidden {
      display: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-box {
      background: #111827;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-box .number {
      font-size: 2rem;
      font-weight: bold;
      color: #4ecca3;
    }

    .stat-box.found .number { color: #4ecca3; }
    .stat-box.emails .number { color: #60a5fa; }
    .stat-box.scanned .number { color: #f59e0b; }
    .stat-box.rating .number { color: #a78bfa; }

    .stat-box .label {
      color: #888;
      font-size: 0.85rem;
      margin-top: 5px;
    }

    .progress-container {
      margin: 20px 0;
    }

    .progress-bar {
      height: 12px;
      background: #111827;
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ecca3, #3db892);
      border-radius: 6px;
      transition: width 0.3s;
    }

    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #888;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-badge.running {
      background: rgba(78, 204, 163, 0.2);
      color: #4ecca3;
      animation: pulse 2s infinite;
    }

    .status-badge.stopped {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .logs-container {
      max-height: 300px;
      overflow-y: auto;
      background: #111827;
      border-radius: 8px;
      padding: 15px;
    }

    .log-entry {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 0.9rem;
      border-left: 3px solid #4ecca3;
      background: rgba(78, 204, 163, 0.1);
    }

    .log-time {
      color: #666;
      font-size: 0.8rem;
      float: right;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .results-table th,
    .results-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    .results-table th {
      background: #111827;
      color: #4ecca3;
      font-weight: 600;
    }

    .results-table tr:hover {
      background: #111827;
    }

    .table-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .alert-success {
      background: rgba(78, 204, 163, 0.1);
      border: 1px solid #4ecca3;
      color: #4ecca3;
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      color: #ef4444;
    }

    .download-btn {
      background: #60a5fa;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 10px;
      font-weight: 600;
    }

    .download-btn:hover {
      background: #3b82f6;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Google Maps Business Scraper</h1>
      <p>Extract business leads with contact information from Google Maps</p>
    </header>

    <div id="alertContainer"></div>

    <div class="grid">
      <!-- Scraper Settings -->
      <div class="card">
        <h2>Scraper Settings</h2>

        <label>Service Type</label>
        <input type="text" id="serviceType" value="plumbers" placeholder="e.g., plumbers, roofers">

        <div class="form-row">
          <div>
            <label>City</label>
            <input type="text" id="city" value="Phoenix" placeholder="e.g., Phoenix">
          </div>
          <div>
            <label>State</label>
            <input type="text" id="state" value="Arizona" placeholder="e.g., Arizona">
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Max Results</label>
            <input type="number" id="maxResults" value="10" min="1" max="50">
          </div>
          <div>
            <label>Min Reviews</label>
            <input type="number" id="minReviews" value="2" min="0" max="100">
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Min Stars</label>
            <input type="number" id="minStars" value="2.0" min="0" max="5" step="0.1">
          </div>
          <div>
            <label>Max Stars</label>
            <input type="number" id="maxStars" value="3.9" min="0" max="5" step="0.1">
          </div>
        </div>

        <label>Extract Emails</label>
        <select id="extractEmails">
          <option value="false">No (Faster)</option>
          <option value="true">Yes (Slower, visits websites)</option>
        </select>

        <button class="btn btn-primary" id="startBtn" onclick="startScraper()">Start Scraping</button>
        <button class="btn btn-danger hidden" id="stopBtn" onclick="stopScraper()">Stop Scraper</button>
      </div>

      <!-- Quick Presets -->
      <div class="card">
        <h2>Quick Presets</h2>
        <p style="color: #888; margin-bottom: 15px;">Load common scraping configurations</p>

        <button class="btn btn-primary" style="margin-bottom: 10px;" onclick="loadPreset('plumbers')">
          Plumbers (2-3.9 stars)
        </button>
        <button class="btn btn-primary" style="margin-bottom: 10px;" onclick="loadPreset('roofers')">
          Roofers (2-3.9 stars)
        </button>
        <button class="btn btn-primary" style="margin-bottom: 10px;" onclick="loadPreset('solar')">
          Solar Companies (2-3.9 stars)
        </button>
        <button class="btn btn-primary" onclick="loadPreset('restaurants')">
          Restaurants (1-3.5 stars)
        </button>
      </div>

      <!-- Progress -->
      <div class="card card-full">
        <h2>
          Scraping Progress
          <span class="status-badge stopped" id="statusBadge">Stopped</span>
        </h2>

        <div class="stats-grid">
          <div class="stat-box found">
            <div class="number" id="statFound">0</div>
            <div class="label">Found</div>
          </div>
          <div class="stat-box emails">
            <div class="number" id="statEmails">0</div>
            <div class="label">Emails</div>
          </div>
          <div class="stat-box scanned">
            <div class="number" id="statScanned">0</div>
            <div class="label">Scanned</div>
          </div>
          <div class="stat-box rating">
            <div class="number" id="statAvgRating">-</div>
            <div class="label">Avg Rating</div>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div class="progress-text" id="progressText">Ready to start</div>
        </div>

        <h3 style="margin: 20px 0 10px; color: #888;">Activity Log</h3>
        <div class="logs-container" id="logsContainer">
          <p style="color: #666; text-align: center;">No activity yet</p>
        </div>
      </div>

      <!-- Results -->
      <div class="card card-full">
        <h2>
          Results
          <div style="margin-left: auto; display: flex; gap: 10px;">
            <button class="download-btn" onclick="downloadCSV()" id="downloadCSVBtn" disabled>Download CSV</button>
            <button class="download-btn" onclick="downloadJSON()" id="downloadJSONBtn" disabled>Download JSON</button>
          </div>
        </h2>

        <div class="table-container">
          <table class="results-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Business Name</th>
                <th>Rating</th>
                <th>Reviews</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Website</th>
              </tr>
            </thead>
            <tbody id="resultsTable">
              <tr><td colspan="7" style="text-align: center; color: #666;">No results yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let statusInterval = null;
    let currentResults = [];

    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    function loadPreset(type) {
      const presets = {
        plumbers: { service: 'plumbers', city: 'Phoenix', state: 'Arizona', minStars: 2.0, maxStars: 3.9, minReviews: 2 },
        roofers: { service: 'roofing contractors', city: 'Houston', state: 'Texas', minStars: 2.0, maxStars: 3.9, minReviews: 3 },
        solar: { service: 'solar installation companies', city: 'Los Angeles', state: 'California', minStars: 2.0, maxStars: 3.9, minReviews: 2 },
        restaurants: { service: 'restaurants', city: 'Miami', state: 'Florida', minStars: 1.0, maxStars: 3.5, minReviews: 5 }
      };

      const preset = presets[type];
      if (preset) {
        document.getElementById('serviceType').value = preset.service;
        document.getElementById('city').value = preset.city;
        document.getElementById('state').value = preset.state;
        document.getElementById('minStars').value = preset.minStars;
        document.getElementById('maxStars').value = preset.maxStars;
        document.getElementById('minReviews').value = preset.minReviews;
        showAlert(`Loaded ${type} preset`);
      }
    }

    async function startScraper() {
      const serviceType = document.getElementById('serviceType').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const maxResults = parseInt(document.getElementById('maxResults').value);
      const minReviews = parseInt(document.getElementById('minReviews').value);
      const minStars = parseFloat(document.getElementById('minStars').value);
      const maxStars = parseFloat(document.getElementById('maxStars').value);
      const extractEmails = document.getElementById('extractEmails').value === 'true';

      if (!serviceType || !city) {
        showAlert('Please enter service type and city', 'error');
        return;
      }

      if (!confirm(`Start scraping ${serviceType} in ${city}, ${state}?`)) return;

      try {
        const res = await fetch(`${API_BASE}/api/scraper/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serviceType,
            city,
            state,
            maxResults,
            minReviews,
            minStars,
            maxStars,
            extractEmails
          })
        });

        const data = await res.json();

        if (data.error) {
          showAlert(data.error, 'error');
          return;
        }

        showAlert('Scraper started! This may take a few minutes...');
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        document.getElementById('statusBadge').className = 'status-badge running';
        document.getElementById('statusBadge').textContent = 'Running';

        statusInterval = setInterval(updateStatus, 2000);
      } catch (err) {
        showAlert('Failed to start scraper: ' + err.message, 'error');
      }
    }

    async function stopScraper() {
      try {
        await fetch(`${API_BASE}/api/scraper/stop`, { method: 'POST' });
        showAlert('Scraper stopped');
        clearInterval(statusInterval);
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('statusBadge').className = 'status-badge stopped';
        document.getElementById('statusBadge').textContent = 'Stopped';
      } catch (err) {
        showAlert('Failed to stop scraper', 'error');
      }
    }

    async function updateStatus() {
      try {
        const res = await fetch(`${API_BASE}/api/scraper/status`);
        const data = await res.json();

        document.getElementById('statFound').textContent = data.stats.found;
        document.getElementById('statEmails').textContent = data.stats.emails;
        document.getElementById('statScanned').textContent = data.stats.scanned;
        document.getElementById('statAvgRating').textContent = data.stats.avgRating || '-';

        const percent = data.progress || 0;
        document.getElementById('progressFill').style.width = `${percent}%`;
        document.getElementById('progressText').textContent = data.statusText || 'Processing...';

        // Update logs
        const logsContainer = document.getElementById('logsContainer');
        if (data.logs.length > 0) {
          logsContainer.innerHTML = data.logs.slice(-10).reverse().map(log => `
            <div class="log-entry">
              <span>${log.message}</span>
              <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
            </div>
          `).join('');
        }

        // Update results if available
        if (data.results && data.results.length > 0) {
          currentResults = data.results;
          updateResultsTable(data.results);
          document.getElementById('downloadCSVBtn').disabled = false;
          document.getElementById('downloadJSONBtn').disabled = false;
        }

        if (!data.isRunning && statusInterval) {
          clearInterval(statusInterval);
          statusInterval = null;
          document.getElementById('startBtn').classList.remove('hidden');
          document.getElementById('stopBtn').classList.add('hidden');
          document.getElementById('statusBadge').className = 'status-badge stopped';
          document.getElementById('statusBadge').textContent = 'Completed';
          showAlert(`Scraping completed! Found ${data.stats.found} businesses`);
        }
      } catch (err) {
        console.error('Status update failed:', err);
      }
    }

    function updateResultsTable(results) {
      const tbody = document.getElementById('resultsTable');
      if (results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No results yet</td></tr>';
        return;
      }

      tbody.innerHTML = results.map((r, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${r.name || '-'}</td>
          <td>${r.rating ? r.rating + '‚≠ê' : '-'}</td>
          <td>${r.reviewCount || 0}</td>
          <td>${r.phone || '-'}</td>
          <td>${r.email || '-'}</td>
          <td>${r.website ? '<a href="' + r.website + '" target="_blank" style="color: #4ecca3;">Link</a>' : '-'}</td>
        </tr>
      `).join('');
    }

    function downloadCSV() {
      if (currentResults.length === 0) {
        showAlert('No results to download', 'error');
        return;
      }

      const headers = ['Business Name', 'Rating', 'Review Count', 'Phone', 'Email', 'Website', 'Address', 'Service Type', 'Location'];
      const rows = currentResults.map(r => [
        `"${(r.name || '').replace(/"/g, '""')}"`,
        r.rating || '',
        r.reviewCount || '',
        r.phone || '',
        r.email || '',
        r.website || '',
        `"${(r.address || '').replace(/"/g, '""')}"`,
        r.serviceType || '',
        r.searchLocation || ''
      ]);

      const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `scraper_results_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showAlert('CSV downloaded successfully');
    }

    function downloadJSON() {
      if (currentResults.length === 0) {
        showAlert('No results to download', 'error');
        return;
      }

      const jsonContent = JSON.stringify(currentResults, null, 2);
      const blob = new Blob([jsonContent], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `scraper_results_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showAlert('JSON downloaded successfully');
    }
  </script>
</body>
</html>
