<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Campaign Sender</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e4e4e4;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid #333;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 10px;
    }

    header p {
      color: #888;
      font-size: 1.1rem;
    }

    .sender-info {
      background: #0f3460;
      padding: 10px 20px;
      border-radius: 8px;
      display: inline-block;
      margin-top: 15px;
    }

    .sender-info span {
      color: #4ecca3;
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #1f2937;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #333;
    }

    .card h2 {
      color: #4ecca3;
      margin-bottom: 20px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-full {
      grid-column: 1 / -1;
    }

    /* Form Elements */
    label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
      font-size: 0.9rem;
    }

    select, input[type="number"], input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #111827;
      color: #fff;
      font-size: 1rem;
      margin-bottom: 15px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #4ecca3;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: #4ecca3;
      color: #1a1a2e;
    }

    .btn-primary:hover {
      background: #3db892;
    }

    .btn-secondary {
      background: #374151;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-danger {
      background: #ef4444;
      color: #fff;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: #111827;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-box .number {
      font-size: 2rem;
      font-weight: bold;
      color: #4ecca3;
    }

    .stat-box.sent .number { color: #4ecca3; }
    .stat-box.failed .number { color: #ef4444; }
    .stat-box.skipped .number { color: #f59e0b; }
    .stat-box.total .number { color: #60a5fa; }

    .stat-box .label {
      color: #888;
      font-size: 0.85rem;
      margin-top: 5px;
    }

    /* Progress Bar */
    .progress-container {
      margin: 20px 0;
    }

    .progress-bar {
      height: 12px;
      background: #111827;
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ecca3, #3db892);
      border-radius: 6px;
      transition: width 0.3s;
    }

    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #888;
    }

    /* Contacts Table */
    .contacts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .contacts-table th,
    .contacts-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    .contacts-table th {
      background: #111827;
      color: #4ecca3;
      font-weight: 600;
    }

    .contacts-table tr:hover {
      background: #111827;
    }

    .table-container {
      max-height: 300px;
      overflow-y: auto;
    }

    /* Logs */
    .logs-container {
      max-height: 250px;
      overflow-y: auto;
      background: #111827;
      border-radius: 8px;
      padding: 15px;
    }

    .log-entry {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
    }

    .log-entry.sent {
      background: rgba(78, 204, 163, 0.1);
      border-left: 3px solid #4ecca3;
    }

    .log-entry.failed {
      background: rgba(239, 68, 68, 0.1);
      border-left: 3px solid #ef4444;
    }

    .log-entry.skipped {
      background: rgba(245, 158, 11, 0.1);
      border-left: 3px solid #f59e0b;
    }

    .log-time {
      color: #666;
      font-size: 0.8rem;
    }

    /* Preview */
    .preview-frame {
      width: 100%;
      height: 400px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #fff;
    }

    .preview-info {
      background: #111827;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .preview-info p {
      margin: 5px 0;
    }

    .preview-info strong {
      color: #4ecca3;
    }

    /* Status Badge */
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-badge.running {
      background: rgba(78, 204, 163, 0.2);
      color: #4ecca3;
      animation: pulse 2s infinite;
    }

    .status-badge.stopped {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Alert */
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .alert-success {
      background: rgba(78, 204, 163, 0.1);
      border: 1px solid #4ecca3;
      color: #4ecca3;
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      color: #ef4444;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Email Campaign Sender</h1>
      <p>Professional bulk email campaigns via SMTP</p>
      <div class="sender-info">
        Sending from: <span id="senderEmail">Loading...</span>
      </div>
    </header>

    <div id="alertContainer"></div>

    <div class="grid">
      <!-- Campaign Controls -->
      <div class="card">
        <h2>Campaign Settings</h2>

        <label>Email Template</label>
        <select id="templateSelect">
          <option value="">Loading templates...</option>
        </select>

        <label>Number of Emails</label>
        <input type="number" id="emailLimit" value="10" min="1" max="500">

        <label>Delay Between Emails (ms)</label>
        <input type="number" id="emailDelay" value="2000" min="1000" max="10000" step="500">

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="sendTestEmail()">Send Test</button>
          <button class="btn btn-primary" id="startBtn" onclick="startCampaign()">Start Campaign</button>
          <button class="btn btn-danger hidden" id="stopBtn" onclick="stopCampaign()">Stop</button>
        </div>
      </div>

      <!-- Upload Contacts -->
      <div class="card">
        <h2>Upload Contacts</h2>

        <label>CSV Files (up to 10 files - must have Email column)</label>
        <input type="file" id="csvFile" accept=".csv" multiple>
        <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">
          Select multiple files to combine contacts from different sources
        </p>

        <button class="btn btn-secondary" onclick="uploadCSV()">Upload CSV(s)</button>
        <button class="btn btn-secondary" onclick="clearUploads()" style="margin-top: 10px;">Clear Uploads</button>

        <div id="contactStats" style="margin-top: 20px;">
          <p>Files Loaded: <strong id="filesLoaded">0</strong></p>
          <p>Contacts: <strong id="contactCount">0</strong></p>
          <p>With Phone: <strong id="withPhone">0</strong></p>
          <p>With Website: <strong id="withWebsite">0</strong></p>
        </div>
      </div>

      <!-- Campaign Progress -->
      <div class="card card-full">
        <h2>
          Campaign Progress
          <span class="status-badge stopped" id="statusBadge">Stopped</span>
        </h2>

        <div class="stats-grid">
          <div class="stat-box sent">
            <div class="number" id="statSent">0</div>
            <div class="label">Sent</div>
          </div>
          <div class="stat-box failed">
            <div class="number" id="statFailed">0</div>
            <div class="label">Failed</div>
          </div>
          <div class="stat-box skipped">
            <div class="number" id="statSkipped">0</div>
            <div class="label">Skipped</div>
          </div>
          <div class="stat-box total">
            <div class="number" id="statTotal">0</div>
            <div class="label">Total</div>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div class="progress-text" id="progressText">0% Complete</div>
        </div>

        <h3 style="margin: 20px 0 10px; color: #888;">Recent Activity</h3>
        <div class="logs-container" id="logsContainer">
          <p style="color: #666; text-align: center;">No activity yet</p>
        </div>
      </div>

      <!-- Preview -->
      <div class="card card-full">
        <h2>Email Preview</h2>

        <div class="preview-info" id="previewInfo">
          <p><strong>To:</strong> <span id="previewTo">-</span></p>
          <p><strong>Subject:</strong> <span id="previewSubject">-</span></p>
        </div>

        <button class="btn btn-secondary" onclick="loadPreview()" style="margin-bottom: 15px;">Load Preview</button>

        <iframe class="preview-frame" id="previewFrame"></iframe>
      </div>

      <!-- Contacts List -->
      <div class="card card-full">
        <h2>Contacts</h2>
        <div class="table-container">
          <table class="contacts-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Company</th>
                <th>Email</th>
                <th>Phone</th>
                <th>City</th>
              </tr>
            </thead>
            <tbody id="contactsTable">
              <tr><td colspan="5" style="text-align: center; color: #666;">Loading contacts...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let statusInterval = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadHealth();
      loadTemplates();
      loadContacts();
    });

    // Show alert
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    // Load health/config
    async function loadHealth() {
      try {
        const res = await fetch(`${API_BASE}/api/health`);
        const data = await res.json();
        document.getElementById('senderEmail').textContent = data.gmail;
      } catch (err) {
        document.getElementById('senderEmail').textContent = 'Error loading';
      }
    }

    // Load templates
    async function loadTemplates() {
      try {
        const res = await fetch(`${API_BASE}/api/templates`);
        const templates = await res.json();
        const select = document.getElementById('templateSelect');
        select.innerHTML = templates.map(t =>
          `<option value="${t.filename}" data-type="${t.type}">${t.name} (${t.type})</option>`
        ).join('');
      } catch (err) {
        showAlert('Failed to load templates', 'error');
      }
    }

    // Load contacts
    async function loadContacts() {
      try {
        const res = await fetch(`${API_BASE}/api/contacts`);
        const data = await res.json();

        document.getElementById('filesLoaded').textContent = data.filesLoaded || 1;
        document.getElementById('contactCount').textContent = data.count;
        document.getElementById('withPhone').textContent = data.stats.withPhone;
        document.getElementById('withWebsite').textContent = data.stats.withWebsite;

        const tbody = document.getElementById('contactsTable');
        if (data.contacts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No contacts found</td></tr>';
          return;
        }

        tbody.innerHTML = data.contacts.map((c, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${c.company || '-'}</td>
            <td>${c.email}</td>
            <td>${c.phone || '-'}</td>
            <td>${c.city || '-'}</td>
          </tr>
        `).join('');
      } catch (err) {
        showAlert('Failed to load contacts', 'error');
      }
    }

    // Upload multiple CSV files
    async function uploadCSV() {
      const fileInput = document.getElementById('csvFile');
      if (!fileInput.files || fileInput.files.length === 0) {
        showAlert('Please select at least one CSV file', 'error');
        return;
      }

      if (fileInput.files.length > 10) {
        showAlert('Maximum 10 files allowed', 'error');
        return;
      }

      const formData = new FormData();
      for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('csvFiles', fileInput.files[i]);
      }

      try {
        const res = await fetch(`${API_BASE}/api/upload`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.error) {
          showAlert(data.error, 'error');
          return;
        }

        showAlert(`Uploaded ${data.filesUploaded} file(s) with ${data.count} total contacts`);
        document.getElementById('filesLoaded').textContent = data.filesUploaded;
        loadContacts();
      } catch (err) {
        showAlert('Upload failed: ' + err.message, 'error');
      }
    }

    // Clear uploaded files
    async function clearUploads() {
      try {
        const res = await fetch(`${API_BASE}/api/clear-uploads`, {
          method: 'POST'
        });
        const data = await res.json();

        if (data.error) {
          showAlert(data.error, 'error');
          return;
        }

        showAlert('Uploaded files cleared');
        document.getElementById('csvFile').value = '';
        loadContacts(); // Refresh the contacts table with default contacts
      } catch (err) {
        showAlert('Clear failed: ' + err.message, 'error');
      }
    }

    // Load preview
    async function loadPreview() {
      const template = document.getElementById('templateSelect').value;
      if (!template) {
        showAlert('Select a template first', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/preview`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contactIndex: 0, templateName: template })
        });
        const data = await res.json();

        if (data.error) {
          showAlert(data.error, 'error');
          return;
        }

        document.getElementById('previewTo').textContent = data.to;
        document.getElementById('previewSubject').textContent = data.subject;

        const iframe = document.getElementById('previewFrame');

        // Handle plain text vs HTML preview
        if (data.isPlainText) {
          // Display plain text in a readable format
          iframe.srcdoc = `<html><head><style>body{font-family:monospace;white-space:pre-wrap;padding:20px;background:#f9fafb;color:#333;}</style></head><body>${data.text}</body></html>`;
        } else {
          iframe.srcdoc = data.html;
        }
      } catch (err) {
        showAlert('Failed to load preview', 'error');
      }
    }

    // Send test email
    async function sendTestEmail() {
      const template = document.getElementById('templateSelect').value;
      if (!template) {
        showAlert('Select a template first', 'error');
        return;
      }

      try {
        showAlert('Sending test email...');
        const res = await fetch(`${API_BASE}/api/send-test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ templateName: template })
        });
        const data = await res.json();

        if (data.error) {
          showAlert(data.error, 'error');
          return;
        }

        showAlert(data.success ? 'Test email sent! Check your inbox.' : 'Test failed: ' + data.error,
                  data.success ? 'success' : 'error');
      } catch (err) {
        showAlert('Failed to send test', 'error');
      }
    }

    // Start campaign
    async function startCampaign() {
      const template = document.getElementById('templateSelect').value;
      const limit = parseInt(document.getElementById('emailLimit').value);
      const delay = parseInt(document.getElementById('emailDelay').value);

      if (!template) {
        showAlert('Select a template first', 'error');
        return;
      }

      if (!confirm(`Start campaign to send ${limit} emails?`)) return;

      try {
        const res = await fetch(`${API_BASE}/api/campaign/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ templateName: template, limit, delay })
        });
        const data = await res.json();

        if (data.error) {
          showAlert(data.error, 'error');
          return;
        }

        showAlert('Campaign started!');
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        document.getElementById('statusBadge').className = 'status-badge running';
        document.getElementById('statusBadge').textContent = 'Running';

        // Start polling for status
        statusInterval = setInterval(updateStatus, 1000);
      } catch (err) {
        showAlert('Failed to start campaign', 'error');
      }
    }

    // Stop campaign
    async function stopCampaign() {
      try {
        await fetch(`${API_BASE}/api/campaign/stop`, { method: 'POST' });
        showAlert('Campaign stopped');
        clearInterval(statusInterval);
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('statusBadge').className = 'status-badge stopped';
        document.getElementById('statusBadge').textContent = 'Stopped';
      } catch (err) {
        showAlert('Failed to stop campaign', 'error');
      }
    }

    // Update status
    async function updateStatus() {
      try {
        const res = await fetch(`${API_BASE}/api/campaign/status`);
        const data = await res.json();

        // Update stats
        document.getElementById('statSent').textContent = data.progress.sent;
        document.getElementById('statFailed').textContent = data.progress.failed;
        document.getElementById('statSkipped').textContent = data.progress.skipped;
        document.getElementById('statTotal').textContent = data.progress.total;

        // Update progress bar
        const processed = data.progress.sent + data.progress.failed + data.progress.skipped;
        const percent = data.progress.total > 0 ? Math.round((processed / data.progress.total) * 100) : 0;
        document.getElementById('progressFill').style.width = `${percent}%`;
        document.getElementById('progressText').textContent = `${percent}% Complete (${processed}/${data.progress.total})`;

        // Update logs
        const logsContainer = document.getElementById('logsContainer');
        if (data.recentLogs.length > 0) {
          logsContainer.innerHTML = data.recentLogs.reverse().map(log => `
            <div class="log-entry ${log.status}">
              <span>${log.status.toUpperCase()}: ${log.email} ${log.company ? `(${log.company})` : ''}</span>
              <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
            </div>
          `).join('');
        }

        // Check if campaign finished
        if (!data.isRunning && statusInterval) {
          clearInterval(statusInterval);
          statusInterval = null;
          document.getElementById('startBtn').classList.remove('hidden');
          document.getElementById('stopBtn').classList.add('hidden');
          document.getElementById('statusBadge').className = 'status-badge stopped';
          document.getElementById('statusBadge').textContent = 'Completed';
          showAlert('Campaign completed!');
        }
      } catch (err) {
        console.error('Status update failed:', err);
      }
    }
  </script>
</body>
</html>
